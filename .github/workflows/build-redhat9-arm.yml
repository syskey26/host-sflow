name: Build hsflowd RPM (Official RHEL9 ARM Strict)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-strict:
    name: Build Native ARM64 (Official Config)
    runs-on: ubuntu-24.04-arm
    container:
      image: rockylinux:9

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Dependencies (Official Dockerfile)
      run: |
        dnf -y update

        dnf -y install clang

        dnf -y --enablerepo=crb install \
              git \
              libpcap-devel \
              libvirt-devel \
              libnfnetlink-devel \
              libxml2-devel \
              dbus-devel \
              openssl-devel \
              rsync \
              rpm-build \
              libuuid-devel \
              make tar wget

    - name: Fix Git Trust
      run: git config --global --add safe.directory $GITHUB_WORKSPACE

    - name: Build RPM (Official Script Logic)
      run: |
        echo "Starting build with full features..."
        
        make rpm FEATURES="NFLOG PCAP TCP DOCKER KVM OVS DBUS SYSTEMD PSAMPLE DENT DROPMON"

    - name: Rename Artifacts (Optional/Mimic Script)
      run: |
        PLATFORM="el9"
        mkdir -p packages

        find . -name "hsflowd-*.rpm" -not -name "*-debug*" | while read rpm; do
           filename=$(basename "$rpm")
           newname="${filename/hsflowd/hsflowd-$PLATFORM}"
           echo "Renaming $rpm -> packages/$newname"
           cp "$rpm" "packages/$newname"
        done

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hsflowd-rhel9-arm64
        path: packages/*.rpm
